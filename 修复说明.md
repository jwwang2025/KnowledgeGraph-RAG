# 修复说明：检索和图谱加载问题

## 问题描述

运行系统提问时，一直显示"检索中"，并且图谱也一直在加载。

## 问题原因分析

经过代码分析，发现了以下几个主要问题：

1. **性能问题**：`graph_utils.py` 中的 `search_node_item` 函数每次请求都会重新读取整个 `data/data.json` 文件，如果文件很大，会导致每次请求都很慢。

2. **缺少错误处理**：前端没有对 fetch 请求进行错误处理，如果后端出错或超时，前端会一直等待。

3. **缺少超时机制**：Wikipedia 搜索和 NER 处理没有超时机制，如果网络慢或处理时间长，会导致整个流程卡住。

4. **缺少调试日志**：关键步骤没有日志输出，难以排查问题。

5. **节点比较问题**：`graph_utils.py` 中使用字典对象比较来查找节点，可能导致问题。

## 修复内容

### 1. 优化 `server/app/utils/graph_utils.py`

- **添加数据缓存机制**：使用全局变量缓存知识图谱数据，避免每次请求都重新读取文件
- **文件修改检测**：检查文件修改时间，只有在文件被修改时才重新加载
- **修复节点比较逻辑**：使用节点名称来查找节点，而不是对象比较
- **添加日志输出**：在关键步骤添加日志，便于调试

### 2. 优化 `server/app/utils/chat_glm.py`

- **添加异常处理**：为实体识别、知识图谱查询、图片搜索、Wikipedia 搜索添加 try-catch
- **添加日志输出**：在关键步骤添加日志，便于排查问题

### 3. 优化 `server/app/utils/query_wiki.py`

- **添加日志输出**：记录搜索过程和结果

### 4. 优化前端 `chat-kg/src/views/ChatView.vue`

- **添加超时处理**：设置 60 秒超时，超时后显示错误提示
- **添加错误处理**：使用 `.catch()` 捕获请求错误，显示友好的错误信息
- **改进数据接收逻辑**：添加 `hasReceivedData` 标志，确保即使没有收到数据也能显示错误

### 5. 优化前端 `chat-kg/src/views/GraphView.vue`

- **添加错误处理**：为图谱数据加载添加错误处理
- **修复事件绑定**：将点击事件绑定移到数据加载完成后
- **添加数据验证**：检查响应数据是否有效

## 使用建议

### 1. 检查后端日志

启动后端服务后，查看控制台输出，应该能看到类似以下的日志：

```
[graph_utils] 加载知识图谱数据: /path/to/data/data.json
[graph_utils] 知识图谱数据加载完成: 1000 个节点, 5000 条边
[stream_predict] 收到用户输入: 你的问题
[stream_predict] 开始实体识别...
[stream_predict] 识别到的实体: ['实体1', '实体2']
[stream_predict] 开始查询知识图谱...
[graph_utils] 搜索节点: 实体1
[graph_utils] 搜索完成: 找到 10 个节点, 15 条边
```

如果某个步骤卡住，日志会显示卡在哪一步。

### 2. 检查数据文件

确保 `server/data/data.json` 文件存在且格式正确：

```bash
cd server
python -c "import json; data = json.load(open('data/data.json')); print(f'节点数: {len(data.get(\"nodes\", []))}, 边数: {len(data.get(\"links\", []))}')"
```

### 3. 检查网络连接

如果 Wikipedia 搜索很慢，可能是网络问题。可以：
- 检查网络连接
- 考虑添加代理
- 或者暂时禁用 Wikipedia 搜索功能

### 4. 检查模型加载

确保 ChatGLM 模型和 NER 模型都已正确加载：
- 查看后端启动日志，确认模型加载成功
- 检查模型路径是否正确

## 进一步优化建议

如果问题仍然存在，可以考虑以下优化：

1. **异步处理**：将实体识别、图谱查询、Wikipedia 搜索改为异步处理，避免阻塞
2. **添加进度提示**：在前端显示当前处理步骤（如"正在识别实体..."、"正在查询图谱..."）
3. **添加重试机制**：对于网络请求失败的情况，自动重试
4. **优化图谱查询算法**：如果图谱数据很大，考虑使用索引或数据库来加速查询

## 测试步骤

1. 重启后端服务：
   ```bash
   cd server
   python main.py
   ```

2. 重启前端服务：
   ```bash
   cd chat-kg
   npm run dev
   ```

3. 测试提问功能：
   - 输入一个问题
   - 观察后端日志输出
   - 检查前端是否正常显示结果

4. 如果仍然卡住：
   - 查看后端日志，确定卡在哪一步
   - 检查浏览器控制台是否有错误
   - 检查网络请求是否正常

## 常见问题

### Q: 仍然显示"检索中"怎么办？

A: 
1. 打开浏览器开发者工具（F12），查看 Network 标签，检查 `/api/chat` 请求的状态
2. 查看后端控制台日志，确定卡在哪一步
3. 检查 `server/data/data.json` 文件是否存在且可读

### Q: 图谱一直加载怎么办？

A:
1. 检查 `/api/graph` 请求是否成功
2. 查看浏览器控制台是否有错误
3. 检查 `server/data/data.json` 文件大小，如果太大可能需要优化

### Q: 后端日志显示"无法找到 data/data.json"？

A:
1. 确保在 `server` 目录下运行 `python main.py`
2. 检查 `server/data/data.json` 文件是否存在
3. 如果文件在其他位置，需要修改 `graph_utils.py` 中的路径

